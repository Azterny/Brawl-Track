<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brawl Track - Admin Panel</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Styles spécifiques pour les actions Admin */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-section {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; color: #fff; }

        table { width: 100%; border-collapse: collapse; color: #ddd; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        th { background-color: #2c2c2c; color: #f1c40f; }
        tr:hover { background-color: #252525; }

        /* --- STYLES DES BOUTONS D'ACTION --- */
        .action-btn {
            padding: 6px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            color: white;
            transition: opacity 0.2s;
        }
        .action-btn:hover { opacity: 0.8; }

        /* Couleurs demandées */
        .btn-green { background-color: #27ae60; }   /* Vert (+) */
        .btn-white { background-color: #ecf0f1; color: #333; } /* Blanc (R) */
        .btn-red { background-color: #c0392b; }     /* Rouge (X, DEL) */
        .btn-orange { background-color: #d35400; }  /* Orange (UNCLAIM) */
        .btn-blue { background-color: #2980b9; }    /* Bleu (EDIT) */

        /* Formulaire d'ajout */
        .add-form { display: flex; gap: 10px; margin-bottom: 20px; }
        .add-form input, .add-form select { padding: 8px; border-radius: 4px; border: 1px solid #444; background: #333; color: white; }
    </style>
</head>
<body>

    <nav style="background: #000; padding: 15px; text-align: center;">
        <a href="index.html" style="color: #fff; text-decoration: none; margin-right: 20px;">← Retour au Site</a>
        <span style="color: #f1c40f; font-weight: bold;">PANNEAU ADMINISTRATION</span>
    </nav>

    <div class="admin-container">
        
        <div class="admin-section">
            <h2>Gestion Utilisateurs</h2>
            <div class="add-form">
                <input type="text" id="newUsername" placeholder="Nouvel utilisateur...">
                <input type="password" id="newPassword" placeholder="Mot de passe...">
                <button class="action-btn btn-green" onclick="createUser()">Ajouter User</button>
            </div>

            <table id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Grade (Tier)</th>
                        <th style="width: 180px;">Actions</th> </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div class="admin-section">
            <h2>Gestion des Tags</h2>
            <table id="tagsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tag</th>
                        <th>Propriétaire (ID)</th>
                        <th>Refresh (min)</th>
                        <th>Dernière MAJ</th>
                        <th style="width: 250px;">Actions</th> </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

    </div>

    <script>
        const API_URL = 'https://brawl-track.com/api'; // Adapter si localhost
        // Récupération du mot de passe Admin (stocké en local pour la session admin simplifiée)
        const ADMIN_PASS = prompt("Entrez le mot de passe Admin (Header X-Admin-Pass) :") || "";

        // Headers pour les requêtes
        const headers = {
            'Content-Type': 'application/json',
            'X-Admin-Pass': ADMIN_PASS
        };

        async function fetchData() {
            if(!ADMIN_PASS) return alert("Mot de passe requis !");

            // 1. Charger Utilisateurs
            try {
                const resUsers = await fetch(`${API_URL}/admin/users`, { headers });
                if(resUsers.ok) {
                    const users = await resUsers.json();
                    renderUsers(users);
                }
            } catch(e) { console.error("Erreur Users", e); }

            // 2. Charger Tags
            try {
                const resTags = await fetch(`${API_URL}/admin/tags`, { headers });
                if(resTags.ok) {
                    const tags = await resTags.json();
                    renderTags(tags);
                }
            } catch(e) { console.error("Erreur Tags", e); }
        }

        // --- RENDU DES UTILISATEURS ---
        function renderUsers(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${u.id}</td>
                    <td>${u.username}</td>
                    <td>${u.tier || 'basic'}</td>
                    <td>
                        <button class="action-btn btn-green" title="Assigner un Tag" onclick="forceClaim('${u.id}', '${u.username}')">+</button>
                        
                        <button class="action-btn btn-white" title="Renommer" onclick="renameUser('${u.id}', '${u.username}')">R</button>
                        
                        <button class="action-btn btn-red" title="Supprimer Compte" onclick="deleteUser('${u.id}', '${u.username}')">X</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- RENDU DES TAGS ---
        function renderTags(tags) {
            const tbody = document.querySelector('#tagsTable tbody');
            tbody.innerHTML = '';
            tags.forEach(t => {
                // Conversion date propre
                const dateStr = t.last_rec ? new Date(t.last_rec).toLocaleString() : 'Jamais';
                const owner = t.claimer_id ? `User #${t.claimer_id}` : '<span style="color:#7f8c8d">Orphelin</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${t.id}</td>
                    <td style="font-family: monospace; font-weight: bold; color: #f1c40f;">${t.tag_str}</td>
                    <td>${owner}</td>
                    <td>${t.rec_temp}m</td>
                    <td style="font-size: 0.8em;">${dateStr}</td>
                    <td>
                        <button class="action-btn btn-orange" onclick="forceUnclaim('${t.tag_str}')">UNCLAIM</button>
                        
                        <button class="action-btn btn-blue" onclick="window.location.href='admin_edit.html?tag=${encodeURIComponent(t.tag_str)}'">EDIT</button>
                        
                        <button class="action-btn btn-red" onclick="deleteTag('${t.id}', '${t.tag_str}')">DEL</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- FONCTIONS D'ACTION (LOGIQUE FRONTEND & CONFIRMATION) ---

        // 1. UTILISATEURS
        function forceClaim(userId, username) {
            const tag = prompt(`Entrez le TAG à lier de force à ${username} :`);
            if(tag) {
                // TODO: Appeler API backend
                console.log(`Action: Force Claim ${tag} -> User ${userId}`);
                alert("(Simulation) Tag assigné !");
            }
        }

        function renameUser(userId, currentName) {
            const newName = prompt(`Nouveau nom pour ${currentName} :`, currentName);
            if(newName && newName !== currentName) {
                // TODO: Appeler API backend
                console.log(`Action: Rename User ${userId} -> ${newName}`);
            }
        }

        function deleteUser(userId, username) {
            // Confirmation REQUISE pour le rouge
            if(confirm(`⚠️ DANGER ⚠️\nÊtes-vous sûr de vouloir SUPPRIMER l'utilisateur "${username}" ?\nCette action est irréversible.`)) {
                // TODO: Appeler API backend
                console.log(`Action: Delete User ${userId}`);
            }
        }

        // 2. TAGS
        function forceUnclaim(tagStr) {
            if(confirm(`Voulez-vous retirer ce tag (${tagStr}) de son propriétaire actuel ?`)) {
                 // TODO: Appeler API backend
                 console.log(`Action: Unclaim ${tagStr}`);
            }
        }

        function deleteTag(tagId, tagStr) {
            // Confirmation REQUISE pour le rouge
            if(confirm(`⚠️ DANGER ⚠️\nÊtes-vous sûr de vouloir SUPPRIMER le tag "${tagStr}" et TOUT son historique ?\n\nCela effacera les stats, les brawlers, tout.`)) {
                // TODO: Appeler API backend
                console.log(`Action: Delete Tag ID ${tagId}`);
            }
        }

        // Fonction Dummy pour création user
        function createUser() {
            alert("Fonctionnalité backend à implémenter plus tard.");
        }

        // Lancement au chargement
        fetchData();

    </script>
</body>
</html>
