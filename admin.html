<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Brawl Track</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <style>
        body {
            background-color: #050505; /* Fond tr√®s sombre pour la page */
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center; /* Centre la box principale */
        }

        /* --- CONTENEUR PRINCIPAL (LA "BOX") --- */
        .main-container {
            width: 100%;
            max-width: 1200px;
            background-color: #121212; /* Fond de la box */
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        /* --- LOGIN OVERLAY (REMPLACE LE PROMPT) --- */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .login-box {
            background: #1e1e1e;
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #ffce00;
            text-align: center;
            width: 300px;
        }

        /* --- STATS GRID --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            text-align: center;
        }
        .stat-card h3 {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-card p {
            font-size: 1.4em;
            font-weight: bold;
            color: #fff;
            margin: 0;
        }
        
        /* --- CONTROLS --- */
        .controls-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            background: #181818;
            padding: 12px;
            border-radius: 8px;
            align-items: center;
            border: 1px solid #2a2a2a;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #252525;
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        
        /* --- ELEMENTS UI --- */
        select, input[type="text"], input[type="password"] {
            background: #111;
            color: #fff;
            border: 1px solid #444;
            padding: 6px 10px;
            border-radius: 4px;
            outline: none;
        }
        select:focus, input:focus { border-color: #ffce00; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #1a1a1a; color: #888; font-size: 0.85em; text-transform: uppercase; }
        tr:hover { background: #1a1a1a; }
        
        .action-btn { background: #333; border: none; color: #fff; cursor: pointer; padding: 5px 10px; border-radius: 4px; transition: 0.2s; }
        .action-btn:hover { background: #555; }
        .btn-add { background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 4px 8px;}
        .btn-del { background: transparent; color: #ff5555; border: 1px solid #ff5555; border-radius: 4px; cursor: pointer; padding: 4px 8px; }
        .btn-del:hover { background: #ff5555; color: white; }
        
        .badge-tag { background: #222; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; font-family: monospace; color: #ffce00; }
        .hidden { display: none !important; }
        
        /* Switch Mode Vue */
        .view-switch {
            display: flex;
            background: #111;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #444;
        }
        .view-btn {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #888;
            font-weight: 500;
        }
        .view-btn.active {
            background: #333;
            color: #fff;
            font-weight: bold;
        }

        /* Checkbox Style Custom */
        .filter-label { font-size: 0.9em; display: flex; align-items: center; gap: 5px; cursor: pointer; user-select: none;}
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color: #ffce00; margin-top: 0;">üõ°Ô∏è Acc√®s Admin</h2>
            <p style="color: #ccc; font-size: 0.9em;">Veuillez vous identifier</p>
            <input type="password" id="admin-pass-input" placeholder="Mot de passe" style="width: 80%; margin-bottom: 15px; padding: 10px;">
            <br>
            <button onclick="attemptLogin()" style="background: #ffce00; color: #000; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;">Entrer</button>
        </div>
    </div>

    <div class="main-container">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <h1 style="color: #ffce00; margin: 0; font-size: 1.8em;">üõ°Ô∏è Administration</h1>
                <span style="background: #222; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; border: 1px solid #444;">v2.0 Multi-Tag</span>
            </div>
            <div>
                <button onclick="loadData()" class="action-btn">Actualiser</button>
                <button onclick="logout()" style="padding: 8px 15px; background: #8b0000; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">D√©connexion</button>
            </div>
        </div>

        <div id="stats-container">
            <div style="text-align:center; padding: 20px; color: #666;">Chargement des statistiques...</div>
        </div>

        <div class="controls-bar">
            <div class="view-switch">
                <button class="view-btn active" id="btn-view-users" onclick="switchView('users')">Utilisateurs</button>
                <button class="view-btn" id="btn-view-tags" onclick="switchView('tags')">Tous les Tags</button>
            </div>

            <div class="filter-group">
                <span>üîç</span>
                <input type="text" id="search-input" placeholder="Pseudo, ID, Tag..." onkeyup="renderTable()" style="background:transparent; border:none; color:white; padding:0;">
            </div>

            <div class="filter-group">
                <span style="color:#888; font-size:0.9em;">Filtres:</span>
                
                <span id="filters-users" style="display:flex; gap:10px;">
                    <label class="filter-label"><input type="checkbox" onchange="toggleFilter('premium')"> Premium</label>
                    <label class="filter-label"><input type="checkbox" onchange="toggleFilter('active_24h')"> Actif 24h</label>
                </span>

                <span id="filters-tags" class="hidden" style="display:flex; gap:10px;">
                    <label class="filter-label"><input type="checkbox" onchange="toggleFilter('unclaimed')"> Non Claim</label>
                    <label class="filter-label"><input type="checkbox" onchange="toggleFilter('claimed')"> Claimed</label>
                </span>
            </div>

            <div style="margin-left: auto; display: flex; gap: 5px;">
                <select id="sort-select" onchange="renderTable()">
                    <option value="id">ID / Alpha</option>
                    <option value="last_archive">Derni√®re Archive</option>
                    <option value="next_archive">Prochaine Archive</option>
                    <option value="total_archives">Nb Archives</option>
                    <option value="trophies">Troph√©es</option>
                    <option value="owner">Propri√©taire</option>
                </select>
                <button onclick="toggleSortOrder()" id="sort-order-btn" class="action-btn" style="min-width: 30px;">‚ñº</button>
            </div>
        </div>

        <table id="main-table">
            <thead id="table-head"></thead>
            <tbody id="table-body"></tbody>
        </table>

    </div>

    <script src="js/config.js"></script>
    <script>
        // --- GESTION LOGIN ---
        const storedKey = localStorage.getItem('admin_key');
        if (storedKey) {
            document.getElementById('login-overlay').classList.add('hidden');
            loadData(); // Charge les donn√©es si d√©j√† connect√©
        }

        async function attemptLogin() {
            const pass = document.getElementById('admin-pass-input').value;
            // Test simple via API Stats pour v√©rifier le pass
            try {
                const res = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pass })
                });
                
                if (res.ok) {
                    localStorage.setItem('admin_key', pass);
                    document.getElementById('login-overlay').classList.add('hidden');
                    loadData();
                } else {
                    alert("Mot de passe incorrect");
                }
            } catch (e) {
                // Fallback si l'API Login n'existe pas encore : on stocke et on essaie
                localStorage.setItem('admin_key', pass);
                document.getElementById('login-overlay').classList.add('hidden');
                loadData();
            }
        }

        function logout() {
            localStorage.removeItem('admin_key');
            location.reload();
        }

        // --- GLOBAL VARIABLES ---
        let rawUsersData = [];
        let rawTagsData = []; 
        let currentFilters = new Set();
        let sortOrder = 1; 
        let currentView = 'users'; 

        // --- NAVIGATION ---
        function switchView(mode) {
            currentView = mode;
            
            // UI Boutons
            document.getElementById('btn-view-users').className = mode === 'users' ? 'view-btn active' : 'view-btn';
            document.getElementById('btn-view-tags').className = mode === 'tags' ? 'view-btn active' : 'view-btn';
            
            // Gestion Visibilit√© Filtres
            const userFilters = document.getElementById('filters-users');
            const tagFilters = document.getElementById('filters-tags');

            if(mode === 'tags') {
                userFilters.classList.add('hidden');
                tagFilters.classList.remove('hidden');
                // On reset les filtres pour √©viter la confusion
                currentFilters.clear();
                // On d√©coche tout visuellement
                document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
            } else {
                userFilters.classList.remove('hidden');
                tagFilters.classList.add('hidden');
                currentFilters.clear();
                document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
            }

            renderTable();
        }

        // --- LOAD DATA ---
        function loadData() {
            const ADMIN_KEY = localStorage.getItem('admin_key');
            if(!ADMIN_KEY) return; // S√©curit√©

            loadStats(ADMIN_KEY);
            loadUsersList(ADMIN_KEY);
            loadTagsList(ADMIN_KEY);
        }

        async function loadStats(key) {
            try {
                const res = await fetch(`${API_URL}/api/admin/stats`, { headers: { 'X-Admin-Pass': key } });
                if (res.status === 403) throw new Error("Auth Failed");
                const data = await res.json();
                renderStats(data);
            } catch (e) {
                if(e.message === "Auth Failed") logout();
            }
        }

        async function loadUsersList(key) {
            try {
                const res = await fetch(`${API_URL}/api/admin/users`, { headers: { 'X-Admin-Pass': key } });
                const rawApiData = await res.json();
                
                const map = new Map();
                rawApiData.forEach(row => {
                    if (!map.has(row.id)) {
                        map.set(row.id, {
                            id: row.id, username: row.username, tier: row.tier, last_login: row.last_login, 
                            user_interval: row.user_default_interval, tags: []
                        });
                    }
                    if (row.brawl_tag) {
                        map.get(row.id).tags.push({
                            id: row.tag_id,
                            tag_str: row.brawl_tag,
                            interval: row.rec_temp,
                            last_archive: row.last_archive,
                            total_archives: row.total_archives || 0,
                            trophies: 0 
                        });
                    }
                });
                rawUsersData = Array.from(map.values());
                if(currentView === 'users') renderTable();
            } catch(e) { console.error("Err Users", e); }
        }

        async function loadTagsList(key) {
            try {
                const res = await fetch(`${API_URL}/api/admin/tags`, { headers: { 'X-Admin-Pass': key } });
                rawTagsData = await res.json();
                if(currentView === 'tags') renderTable();
            } catch(e) { console.error("Err Tags", e); }
        }

        // --- RENDER STATS ---
        function renderStats(data) {
            const container = document.getElementById('stats-container');
            
            let nextArchiveText = "En attente...";
            let nextArchiveColor = "#888";
            if (data.next_archive_date) {
                const now = new Date();
                const target = new Date(data.next_archive_date.replace(' ', 'T')); 
                const diffMs = target - now;
                const diffMins = Math.ceil(diffMs / 60000);

                if (diffMins <= 0) {
                    nextArchiveText = "Imminent";
                    nextArchiveColor = "#ffce00";
                } else {
                    nextArchiveText = `dans ${diffMins} min`;
                    nextArchiveColor = "#28a745";
                }
            }
            const lastArchText = data.last_archive_date ? formatDate(data.last_archive_date) : "Aucune";

            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Utilisateurs Inscrits</h3>
                        <p>${data.users}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Points d'Historique</h3>
                        <p>${data.records}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Moy. Archives/User</h3>
                        <p>${data.avg_archives}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Tags (Claim / Total)</h3>
                        <p>${data.claimed_tags} <span style="font-size:0.6em; color:#888;">/ ${data.total_tags}</span></p>
                    </div>
                    <div class="stat-card">
                        <h3>Derni√®re Archive</h3>
                        <p style="font-size:0.9em">${lastArchText}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Prochaine Auto</h3>
                        <p style="color:${nextArchiveColor}">${nextArchiveText}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Stockage (Utilis√©/Max)</h3>
                        <p style="font-size:0.8em">${data.disk_str} <span style="font-size:0.8em; color:${data.disk_percent > 80 ? '#ff5555' : '#888'}">(${data.disk_percent}%)</span></p>
                    </div>
                    <div class="stat-card">
                        <h3>Charge CPU / RAM</h3>
                        <div style="font-size: 0.8rem; text-align: left; margin-top: 5px; padding-left: 20px;">
                            CPU: <div style="display:inline-block; width:60px; height:8px; background:#333; border-radius:4px;">
                                    <div style="width:${data.cpu}%; height:100%; background:${getColor(data.cpu)}; border-radius:4px;"></div>
                                 </div> ${data.cpu}%<br>
                            RAM: <div style="display:inline-block; width:60px; height:8px; background:#333; border-radius:4px; margin-top:3px;">
                                    <div style="width:${data.ram}%; height:100%; background:${getColor(data.ram)}; border-radius:4px;"></div>
                                 </div> ${data.ram}%
                        </div>
                    </div>
                </div>
            `;
        }

        // --- RENDER TABLE ---
        function renderTable() {
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            const data = getProcessedData(currentView);

            if (currentView === 'users') renderUsersTable(data, thead, tbody);
            else renderTagsTable(data, thead, tbody);
        }

        function renderUsersTable(data, thead, tbody) {
            thead.innerHTML = `<tr><th style="width:30px"></th><th>ID</th><th>Utilisateur</th><th>Grade</th><th>Derni√®re Connexion</th><th>Total Archives</th><th style="text-align:right">Actions</th></tr>`;
            
            if(data.length === 0) { tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px; color:#666;">Aucun utilisateur trouv√©</td></tr>`; return; }

            data.forEach(u => {
                const row = document.createElement('tr');
                const lastLog = u.last_login ? formatDate(u.last_login) : 'Jamais';
                const totArch = u.tags.reduce((acc, t) => acc + t.total_archives, 0);

                row.innerHTML = `
                    <td><button class="action-btn" onclick="toggleDetails(${u.id})">‚ñº</button></td>
                    <td style="color:#888">#${u.id}</td>
                    <td style="font-weight:bold; color:white">${u.username}</td>
                    <td><select onchange="updateTier(${u.id}, this.value)" style="padding:2px; font-size:0.9em;">
                        <option value="basic" ${u.tier==='basic'?'selected':''}>Basic</option>
                        <option value="subscriber" ${u.tier==='subscriber'?'selected':''}>Abonn√©</option>
                        <option value="premium" ${u.tier==='premium'?'selected':''}>Premium</option>
                    </select></td>
                    <td style="color:#aaa; font-size:0.9em">${lastLog}</td>
                    <td><span style="color:#ffce00">${totArch}</span></td>
                    <td style="text-align:right; display:flex; gap:5px; justify-content:flex-end;">
                        <button class="action-btn" title="Renommer" onclick="renameUser(${u.id}, '${u.username}')">‚úèÔ∏è</button>
                        <button class="btn-add" title="Ajouter un Tag" onclick="adminAddTag(${u.id})">‚ûï</button>
                        <button class="btn-del" title="Supprimer User" onclick="deleteUser(${u.id})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);

                // D√©tails
                const detailRow = document.createElement('tr');
                detailRow.id = `detail-${u.id}`;
                detailRow.className = 'hidden details-row';
                detailRow.style.background = '#0e0e0e';
                
                let tagsHtml = u.tags.map(t => `
                    <tr style="background:transparent; border-bottom:1px solid #222;">
                        <td colspan="2" style="text-align:right; color:#444;">‚Ü≥</td>
                        <td><span class="badge-tag">${t.tag_str}</span></td>
                        <td>
                            <input type="number" value="${t.interval}" 
                                style="width:50px; background:#111; color:#ffce00; border:1px solid #444; border-radius:4px; text-align:center;" 
                                onchange="updateTagFreq(${t.id}, this)" title="Freq (min)"> min
                        </td>
                        <td style="font-size:0.9em">Last: ${t.last_archive ? formatDate(t.last_archive) : 'N/A'}</td>
                        <td style="color:#aaa; font-size:0.9em">Next: ${getNextTime(t.last_archive, t.interval)}</td>
                        <td style="text-align:right">
                            <button class="action-btn" onclick="window.location.href='admin_edit.html?id=${u.id}'">üìù</button>
                            <button class="btn-del" title="D√©tacher" onclick="adminUnclaimTag(${t.id})">üîó‚úñ</button>
                        </td>
                    </tr>
                `).join('');

                if(!tagsHtml) tagsHtml = `<tr><td colspan="7" style="text-align:center; color:#444; font-style:italic; padding:10px;">Aucun tag associ√©</td></tr>`;

                detailRow.innerHTML = `<td colspan="7"><table style="width:95%; margin:auto; margin-bottom:10px;">${tagsHtml}</table></td>`;
                tbody.appendChild(detailRow);
            });
        }

        function renderTagsTable(data, thead, tbody) {
            thead.innerHTML = `<tr><th>Propri√©taire</th><th>Tag</th><th>Freq</th><th>Last Arch.</th><th>Next Arch.</th><th>Troph√©es</th><th style="text-align:right">Actions</th></tr>`;
            
            if(data.length === 0) { tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px; color:#666;">Aucun tag trouv√©</td></tr>`; return; }
            
            data.forEach(item => {
                const u = item.user;
                const t = item.tag;
                
                const ownerDisplay = u 
                    ? `<span style="font-weight:bold; color:white;">${u.username}</span>` 
                    : `<span style="color:#555; font-style:italic;">-- Unclaimed --</span>`;
                    
                const editBtn = u
                    ? `<button class="action-btn" onclick="window.location.href='admin_edit.html?id=${u.id}'" title="Voir User">üìù</button>`
                    : `<button class="action-btn" style="opacity:0.3; cursor:not-allowed;">üìù</button>`;

                const unclaimBtn = u
                    ? `<button class="btn-del" onclick="adminUnclaimTag(${t.id})" title="D√©tacher">üîó‚úñ</button>`
                    : ``;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ownerDisplay}</td>
                    <td><span class="badge-tag">${t.tag_str}</span></td>
                    <td>
                        <input type="number" value="${t.interval}" 
                               style="width:60px; background:#111; color:#ffce00; border:1px solid #444; border-radius:4px; text-align:center; padding:5px;" 
                               onchange="updateTagFreq(${t.id}, this)"> min
                    </td>
                    <td>${t.last_archive ? formatDate(t.last_archive) : 'N/A'}</td>
                    <td>${getNextTime(t.last_archive, t.interval)}</td>
                    <td style="color:#ffce00; font-weight:bold;">${t.trophies || 0} üèÜ</td>
                    <td style="text-align:right">
                        ${editBtn}
                        ${unclaimBtn}
                        <button class="btn-del" style="background:#8b0000; border:1px solid #ff5555;" onclick="adminDeleteTag(${t.id})">üóëÔ∏è Tag</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- UTILS & ACTIONS ---
        const ADMIN_KEY = localStorage.getItem('admin_key');

        async function renameUser(uid, currentName) {
            const newName = prompt("Nouveau pseudo :", currentName);
            if (!newName || newName === currentName) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/user/${uid}/rename`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Pass': ADMIN_KEY },
                    body: JSON.stringify({ username: newName })
                });
                if(res.ok) { alert("‚úÖ Renomm√©"); loadUsersList(ADMIN_KEY); }
            } catch(e) { alert("Erreur r√©seau"); }
        }

        async function adminAddTag(uid) {
            const tag = prompt("Tag √† ajouter (ex: #ABC) :");
            if (!tag) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/user/${uid}/claim`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Pass': ADMIN_KEY },
                    body: JSON.stringify({ tag: tag })
                });
                const d = await res.json();
                alert(d.message);
                if(res.ok) loadUsersList(ADMIN_KEY);
            } catch(e) { alert("Erreur r√©seau"); }
        }

        async function adminUnclaimTag(tagId) {
            if (!confirm("D√©tacher ce tag ?")) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/tag/${tagId}/unclaim`, {
                    method: 'POST', headers: { 'X-Admin-Pass': ADMIN_KEY }
                });
                if(res.ok) loadData();
            } catch(e) { alert("Erreur"); }
        }

        async function adminDeleteTag(tagId) {
            if (!confirm("‚ö†Ô∏è SUPPRIMER D√âFINITIVEMENT CE TAG ?")) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/tag/${tagId}`, {
                    method: 'DELETE', headers: { 'X-Admin-Pass': ADMIN_KEY }
                });
                if(res.ok) { alert("Supprim√©"); loadData(); }
            } catch(e) { alert("Erreur"); }
        }

        async function updateTagFreq(tagId, input) {
            const val = parseInt(input.value);
            if(isNaN(val) || val < 0) return;
            input.style.borderColor = "#ffce00";
            try {
                const res = await fetch(`${API_URL}/api/admin/tag/${tagId}/frequency`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Pass': ADMIN_KEY },
                    body: JSON.stringify({ minutes: val })
                });
                if(res.ok) { 
                    input.style.borderColor = "#28a745";
                    setTimeout(() => input.style.borderColor = "#444", 1000);
                } else input.style.borderColor = "red";
            } catch(e) { input.style.borderColor = "red"; }
        }

        async function updateTier(uid, tier) {
            try {
                const res = await fetch(`${API_URL}/api/admin/update-tier`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Pass': ADMIN_KEY },
                    body: JSON.stringify({ user_id: uid, tier: tier })
                });
                if(res.ok) loadUsersList(ADMIN_KEY);
            } catch(e) { console.error(e); }
        }

        async function deleteUser(uid) {
            if(!confirm("Supprimer l'utilisateur et d√©tacher ses tags ?")) return;
            alert("Veuillez impl√©menter la suppression utilisateur dans le backend (app_admin.py) si n√©cessaire.");
        }

        function getProcessedData(mode) {
            let data = [];
            const search = document.getElementById('search-input').value.toLowerCase();
            const now = new Date();

            if (mode === 'users') {
                data = rawUsersData.filter(u => 
                    u.username.toLowerCase().includes(search) || 
                    u.tags.some(t => t.tag_str.toLowerCase().includes(search))
                );
                if (currentFilters.has('premium')) data = data.filter(u => u.tier === 'premium');
                if (currentFilters.has('active_24h')) data = data.filter(u => u.last_login && (now - new Date(u.last_login)) < 86400000);
                
                // Tri
                const crit = document.getElementById('sort-select').value;
                data.sort((a,b) => {
                    let vA = a.username.toLowerCase(), vB = b.username.toLowerCase();
                    if(crit === 'id') { vA = a.id; vB = b.id; } // Tri par ID user
                    return (vA < vB ? -1 : 1) * sortOrder;
                });

            } else {
                data = rawTagsData.map(t => ({
                    user: t.owner_id ? { id: t.owner_id, username: t.owner_name } : null,
                    tag: {
                        id: t.id, tag_str: t.tag_str, interval: t.rec_temp,
                        last_archive: t.last_archive, total_archives: t.total_archives,
                        trophies: t.current_trophies || 0
                    }
                }));

                data = data.filter(item => {
                    if (search && !item.tag.tag_str.toLowerCase().includes(search) && !(item.user && item.user.username.toLowerCase().includes(search))) return false;
                    if (currentFilters.has('claimed') && !item.user) return false; 
                    if (currentFilters.has('unclaimed') && item.user) return false;
                    return true;
                });

                const crit = document.getElementById('sort-select').value;
                data.sort((a, b) => {
                    let vA, vB;
                    const tA = a.tag, tB = b.tag;
                    if (crit === 'id') { vA = tA.tag_str; vB = tB.tag_str; }
                    else if (crit === 'trophies') { vA = tA.trophies; vB = tB.trophies; }
                    else if (crit === 'next_archive') {
                         vA = tA.last_archive ? new Date(tA.last_archive).getTime() + (tA.interval*60000) : 0;
                         vB = tB.last_archive ? new Date(tB.last_archive).getTime() + (tB.interval*60000) : 0;
                    }
                    else if (crit === 'owner') { 
                        vA = a.user ? a.user.username : 'zzz'; 
                        vB = b.user ? b.user.username : 'zzz'; 
                    }
                    else { vA = tA.last_archive || ''; vB = tB.last_archive || ''; }
                    
                    if (vA < vB) return -1 * sortOrder;
                    if (vA > vB) return 1 * sortOrder;
                    return 0;
                });
            }
            return data;
        }

        function toggleFilter(f) {
            if(currentFilters.has(f)) currentFilters.delete(f);
            else currentFilters.add(f);
            renderTable();
        }

        function toggleSortOrder() {
            sortOrder *= -1;
            document.getElementById('sort-order-btn').innerText = sortOrder === 1 ? '‚ñº' : '‚ñ≤';
            renderTable();
        }

        function toggleDetails(uid) {
            const row = document.getElementById(`detail-${uid}`);
            if(row) row.classList.toggle('hidden');
        }

        function formatDate(str) {
            if(!str) return 'N/A';
            const d = new Date(str.replace(' ', 'T'));
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }

        function getNextTime(lastStr, interval) {
            if(!lastStr || !interval) return 'Pause';
            const next = new Date(new Date(lastStr.replace(' ', 'T')).getTime() + interval*60000);
            const diff = Math.round((next - new Date()) / 60000);
            if(diff < 0) return 'En retard';
            return diff + ' min';
        }

        function getColor(val) {
            if(val < 50) return '#28a745';
            if(val < 80) return '#ffce00';
            return '#ff5555';
        }
    </script>
</body>
</html>
