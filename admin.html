<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Brawl Track</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* BASE */
        body { background-color: #121212; color: #eee; font-family: 'Roboto', sans-serif; margin: 0; padding: 20px; }
        h1, h2 { color: #ffce00; text-transform: uppercase; }

        /* LOGIN */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #login-screen input { padding: 10px; width: 250px; text-align: center; margin-bottom: 10px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; }
        
        /* DASHBOARD */
        .container { max-width: 1200px; margin: 0 auto; display: none; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }

        /* STATS GRILLE (2 Lignes x 4 Colonnes) */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 15px; 
            margin-bottom: 30px; 
        }
        .card { 
            background: #1e1e1e; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #333; 
            text-align: center; 
        }
        .card-val { font-size: 1.5em; font-weight: bold; color: #fff; margin-bottom: 5px; }
        .card-label { color: #888; font-size: 0.8em; text-transform: uppercase; }

        /* FILTRES */
        .filters { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; background: #1e1e1e; padding: 10px; border-radius: 8px; }
        
        /* TABLE & ACCORDION */
        .table-container { overflow-x: auto; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; background: #1e1e1e; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #333; vertical-align: middle; }
        th { background: #252525; color: #ffce00; }
        
        /* Ligne principale */
        .user-row { transition: background 0.2s; }
        .user-row:hover { background: #2a2a2a; }

        /* Zone d√©tails (cach√©e par d√©faut) */
        .details-row { display: none; background: #181818; }
        .details-row.active { display: table-row; animation: fadeIn 0.3s; }
        .details-content { padding: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; color: #aaa; font-size: 0.9em; }
        .details-item strong { color: #fff; display: block; margin-bottom: 5px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI ELEMENTS */
        select, input { padding: 8px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; }
        
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; text-transform: uppercase; }
        .badge-basic { background: #555; }
        .badge-subscriber { background: #0056b3; }
        .badge-premium { background: #ffd700; color: #000; }

        /* BUTTONS */
        button { cursor: pointer; padding: 6px 12px; border: none; border-radius: 4px; color: white; font-weight: bold; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        
        .btn-login { background: #ffce00; color: black; width: 270px; font-size: 1.1em; }
        .btn-refresh { background: #28a745; }
        .btn-save { background: #007bff; margin-left: 5px; }
        .btn-del { background: #dc3545; }
        
        .btn-expand { 
            background: transparent; border: 1px solid #555; color: #ffce00; 
            width: 30px; height: 30px; border-radius: 50%; font-size: 1.2em; line-height: 1;
            padding: 0; display: flex; align-items: center; justify-content: center;
        }
        .btn-expand:hover { background: #333; }

        /* Mobile Responsive Stats */
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="margin-bottom: 30px;">üîí ADMIN ACCESS</h1>
        <input type="password" id="admin-pass" placeholder="Mot de passe Admin" onkeyup="if(event.key === 'Enter') login()">
        <button class="btn-login" onclick="login()">ENTRER</button>
        <p id="login-msg" style="color: #ff5555; margin-top: 15px;"></p>
    </div>

    <div id="dashboard" class="container">
        
        <div class="top-bar">
            <h1 style="margin: 0;">üõ†Ô∏è Panneau de Contr√¥le</h1>
            <button class="btn-refresh" onclick="loadData()">üîÑ Actualiser</button>
        </div>

        <div class="stats-grid">
            <div class="card"><div class="card-val" id="val-users">--</div><div class="card-label">Nombre d'utilisateurs</div></div>
            <div class="card"><div class="card-val" id="val-archives">--</div><div class="card-label">Archives Totales</div></div>
            <div class="card"><div class="card-val" id="val-avg">--</div><div class="card-label">Moyenne / User</div></div>
            <div class="card"><div class="card-val" id="val-disk">--</div><div class="card-label">Disque Utilis√© / Total</div></div>
            
            <div class="card"><div class="card-val" id="val-cpu">--%</div><div class="card-label">CPU Serveur</div></div>
            <div class="card"><div class="card-val" id="val-ram">--%</div><div class="card-label">RAM Serveur</div></div>
            <div class="card"><div class="card-val" id="val-last-date" style="font-size: 1.2em;">--</div><div class="card-label">Date derni√®re archive</div></div>
            <div class="card"><div class="card-val" id="val-next-date" style="font-size: 1.2em;">--</div><div class="card-label">Date prochaine archive</div></div>
        </div>

        <h2>Gestion Utilisateurs</h2>
        
        <div class="filters">
            <label>Trier par :</label>
            <select id="sort-select" onchange="applySort()">
                <option value="id">ID (Cr√©ation)</option>
                <option value="last_archive">Date derni√®re archive</option>
                <option value="last_login">Date derni√®re connexion</option>
                <option value="next_archive">Prochaine Archive (Urgent)</option>
            </select>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;"></th> <th>ID</th>
                        <th>Pseudo</th>
                        <th>Tag</th>
                        <th>Grade</th>
                        <th>Derni√®re Connexion</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table">
                    <tr><td colspan="7" style="text-align:center; padding: 20px; color:#888;">Chargement...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = "https://api.brawl-track.com"; 
        let ADMIN_KEY = "";
        let usersData = [];

        // --- AUTH & LOAD ---
        async function login() {
            const pass = document.getElementById('admin-pass').value;
            if(!pass) return;
            ADMIN_KEY = pass;
            document.getElementById('login-msg').innerText = "Connexion...";

            try {
                const res = await fetch(`${API_URL}/api/admin/users`, { headers: { 'X-Admin-Pass': ADMIN_KEY } });
                if(res.status === 403) throw new Error("Mot de passe incorrect");
                if(!res.ok) throw new Error("Erreur serveur");
                
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadData();
            } catch(e) { document.getElementById('login-msg').innerText = "‚ùå " + e.message; }
        }

        function loadData() {
            loadStats();
            loadUsersList();
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}/api/admin/stats`, { headers: { 'X-Admin-Pass': ADMIN_KEY } });
                const s = await res.json();
                
                // Ligne 1
                document.getElementById('val-users').innerText = s.users;
                document.getElementById('val-archives').innerText = s.total_archives;
                document.getElementById('val-avg').innerText = s.avg_archives_user;
                document.getElementById('val-disk').innerText = s.disk_used_gb + ' / ' + s.disk_total_gb + ' GB';

                // Ligne 2
                document.getElementById('val-cpu').innerText = s.cpu_percent + '%';
                document.getElementById('val-ram').innerText = s.ram_percent + '%';
                document.getElementById('val-last-date').innerText = formatDate(s.last_archive_date);
                document.getElementById('val-next-date').innerText = formatDate(s.next_archive_date);

            } catch(e) { console.error(e); }
        }

        async function loadUsersList() {
            try {
                const res = await fetch(`${API_URL}/api/admin/users`, { headers: { 'X-Admin-Pass': ADMIN_KEY } });
                usersData = await res.json();
                applySort(); 
            } catch(e) { console.error(e); }
        }

        // --- TRI & RENDU ---
        function applySort() {
            const criteria = document.getElementById('sort-select').value;
            
            usersData.sort((a, b) => {
                if (criteria === 'id') return a.id - b.id;
                
                if (criteria === 'last_archive') {
                    if(!a.last_archive) return 1;
                    if(!b.last_archive) return -1;
                    return new Date(b.last_archive) - new Date(a.last_archive);
                }

                if (criteria === 'last_login') {
                    if(!a.last_login) return 1;
                    if(!b.last_login) return -1;
                    return new Date(b.last_login) - new Date(a.last_login);
                }

                if (criteria === 'next_archive') {
                    const nextA = getNextUpdateTime(a.last_archive, a.update_interval);
                    const nextB = getNextUpdateTime(b.last_archive, b.update_interval);
                    return nextA - nextB;
                }
            });
            
            renderUsersTable();
        }

        function getNextUpdateTime(lastStr, intervalMinutes) {
            if(!lastStr) return 0;
            const last = new Date(lastStr);
            return last.getTime() + (intervalMinutes * 60000); 
        }

        function formatDate(dateStr) {
            if(!dateStr || dateStr === 'N/A') return 'N/A';
            const d = new Date(dateStr);
            return d.toLocaleDateString('fr-FR') + ' ' + d.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
        }

        function renderUsersTable() {
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = '';
            
            usersData.forEach(u => {
                let badgeClass = 'badge-basic';
                if(u.tier === 'subscriber') badgeClass = 'badge-subscriber';
                if(u.tier === 'premium') badgeClass = 'badge-premium';

                const lastArchive = u.last_archive ? formatDate(u.last_archive) : "Jamais";
                const lastLogin = u.last_login ? formatDate(u.last_login) : "Jamais";
                
                // Calcul Temps Restant (Prochaine archive)
                let timeRemaining = "En attente";
                let nextDateInfo = "Imm√©diat";
                
                if (u.last_archive) {
                    const nextUpdateTs = getNextUpdateTime(u.last_archive, u.update_interval);
                    const now = new Date().getTime();
                    const diffMinutes = Math.floor((nextUpdateTs - now) / 60000);

                    if (diffMinutes <= 0) {
                        timeRemaining = "<span style='color:#ff5555'>En retard</span>";
                    } else {
                        const h = Math.floor(diffMinutes / 60);
                        const m = diffMinutes % 60;
                        timeRemaining = `<span style='color:#28a745'>Dans ${h}h ${m}min</span>`;
                        nextDateInfo = formatDate(new Date(nextUpdateTs).toISOString());
                    }
                }

                // LIGNE PRINCIPALE
                const trMain = document.createElement('tr');
                trMain.className = 'user-row';
                trMain.innerHTML = `
                    <td><button class="btn-expand" onclick="toggleDetails(${u.id})">‚ñº</button></td>
                    <td>${u.id}</td>
                    <td style="font-weight:bold; color: white;">${u.username}</td>
                    <td style="color:#aaa;">${u.brawl_tag}</td>
                    <td><span class="badge ${badgeClass}">${u.tier}</span></td>
                    <td style="color:#ddd;">${lastLogin}</td>
                    <td style="text-align: right;">
                        <button class="btn-save" style="background:#17a2b8; margin-right:5px;" onclick="window.location.href='admin_edit.html?id=${u.id}'">‚úèÔ∏è</button>
                        <button class="btn-del" onclick="deleteUser(${u.id})">üóëÔ∏è</button>
                    </td>
                `;

                // LIGNE D√âTAILS
                const trDetails = document.createElement('tr');
                trDetails.className = 'details-row';
                trDetails.id = `details-${u.id}`;
                trDetails.innerHTML = `
                    <td colspan="7">
                        <div class="details-content">
                            <div class="details-item">
                                <strong>üìÇ Archives</strong>
                                Total : ${u.total_archives}<br>
                                Derni√®re : ${lastArchive}
                            </div>
                            <div class="details-item">
                                <strong>‚ö° Fr√©quence</strong>
                                Tous les ${u.update_interval} min
                            </div>
                            <div class="details-item">
                                <strong>‚è≥ Prochaine Archive</strong>
                                ${timeRemaining}<br>
                                <span style="font-size:0.8em; color:#666;">Pr√©vu : ${nextDateInfo}</span>
                            </div>
                            
                            <div class="details-item" style="grid-column: 1/-1; border-top: 1px solid #333; padding-top: 10px; margin-top: 5px;">
                                <strong>Modifier le Grade :</strong>
                                <div style="display:flex; gap:10px; align-items:center; margin-top:5px;">
                                    <select id="select-tier-${u.id}">
                                        <option value="basic" ${u.tier === 'basic' ? 'selected' : ''}>Basic</option>
                                        <option value="subscriber" ${u.tier === 'subscriber' ? 'selected' : ''}>Abonn√©</option>
                                        <option value="premium" ${u.tier === 'premium' ? 'selected' : ''}>Premium</option>
                                    </select>
                                    <button class="btn-save" onclick="changeTier(${u.id})">Appliquer</button>
                                </div>
                            </div>
                        </div>
                    </td>
                `;

                tbody.appendChild(trMain);
                tbody.appendChild(trDetails);
            });
        }

        // --- INTERACTIONS ---
        function toggleDetails(id) {
            const row = document.getElementById(`details-${id}`);
            if(row.classList.contains('active')) {
                row.classList.remove('active');
            } else {
                document.querySelectorAll('.details-row.active').forEach(r => r.classList.remove('active'));
                row.classList.add('active');
            }
        }

        async function changeTier(userId) {
            const newTier = document.getElementById(`select-tier-${userId}`).value;
            try {
                await fetch(`${API_URL}/api/admin/set-tier`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Pass': ADMIN_KEY },
                    body: JSON.stringify({ user_id: userId, tier: newTier })
                });
                loadUsersList();
            } catch(e) { alert("Erreur connexion"); }
        }

        async function deleteUser(id) {
            if(!confirm("Supprimer DEFINITIVEMENT cet utilisateur ?")) return;
            try {
                await fetch(`${API_URL}/api/admin/user/${id}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Pass': ADMIN_KEY }
                });
                loadUsersList();
                loadStats();
            } catch(e) { alert("Erreur serveur"); }
        }
    </script>
</body>
</html>
