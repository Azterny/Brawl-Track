<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin Brut - Brawl Track</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <style>
        /* --- STYLE PRIMAIRE & FONCTIONNEL --- */
        body {
            background-color: #000;
            color: #ccc;
            font-family: monospace, sans-serif;
            margin: 0; padding: 20px;
            font-size: 14px;
        }

        /* Cadre Principal */
        #main-container {
            max-width: 1400px;
            margin: 0 auto;
            border: 1px solid #444;
            background: #111;
            padding: 10px;
        }

        /* Login Overlay Simple */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box { border: 2px solid #ffce00; padding: 20px; text-align: center; background: #111; }

        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #ffce00; padding-bottom: 10px; margin-bottom: 15px;
        }
        h1 { margin: 0; color: #ffce00; font-size: 1.5em; text-transform: uppercase; }

        /* Stats Grid (Simple) */
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;
        }
        .stat-box {
            border: 1px solid #333; background: #0a0a0a; padding: 10px;
        }
        .stat-box h3 { margin: 0 0 5px 0; font-size: 0.8em; color: #888; text-transform: uppercase; }
        .stat-box p { margin: 0; font-size: 1.2em; color: #fff; font-weight: bold; }

        /* Barre de Contrôle */
        .controls {
            background: #222; border: 1px solid #444; padding: 10px; margin-bottom: 10px;
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
        }
        
        /* Inputs & Boutons */
        input, select, button {
            background: #000; color: #fff; border: 1px solid #555;
            padding: 5px 10px; font-family: monospace; font-size: 1em; cursor: pointer;
        }
        input:focus, select:focus { border-color: #ffce00; outline: none; }
        
        button:hover { background: #333; }
        button.active { background: #ffce00; color: #000; font-weight: bold; border-color: #ffce00; }
        
        .btn-green { color: #28a745; border-color: #28a745; }
        .btn-green:hover { background: #28a745; color: #000; }
        .btn-red { color: #ff5555; border-color: #ff5555; }
        .btn-red:hover { background: #ff5555; color: #000; }

        /* Tableaux */
        table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
        th { text-align: left; border-bottom: 2px solid #444; padding: 8px; color: #888; text-transform: uppercase; }
        td { border-bottom: 1px solid #222; padding: 6px 8px; vertical-align: middle; }
        tr:hover { background: #1a1a1a; }

        .hidden { display: none !important; }
        .badge { display: inline-block; padding: 2px 5px; border: 1px solid #444; color: #ffce00; font-size: 0.9em; }
        
        /* Checkboxes Labels */
        .filter-label { display: flex; align-items: center; gap: 5px; cursor: pointer; user-select: none; color: #aaa; }
        .filter-label input:checked + span { color: #fff; text-decoration: underline; }

        /* Détails */
        .details-row { background: #080808; border-bottom: 1px solid #444; }
        .details-table td { border: none; color: #888; font-size: 0.9em; padding: 3px 10px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:#ffce00; margin-top:0;">ADMIN ACCESS</h2>
            <input type="password" id="admin-pass" placeholder="Password" style="margin-bottom:10px;">
            <br>
            <button onclick="login()" style="width:100%">ENTER</button>
        </div>
    </div>

    <div id="main-container">
        
        <header>
            <h1>Admin Panel <span style="font-size:0.5em; color:#666;">v3.0 RAW</span></h1>
            <div>
                <button onclick="loadData()">REFRESH</button>
                <button onclick="logout()" class="btn-red">LOGOUT</button>
            </div>
        </header>

        <div id="stats-area" class="stats-grid">Loading Stats...</div>

        <div class="controls">
            <div style="border-right: 1px solid #444; padding-right: 15px;">
                <button id="btn-users" onclick="setView('users')" class="active">UTILISATEURS</button>
                <button id="btn-tags" onclick="setView('tags')">TAGS</button>
            </div>

            <div>
                <input type="text" id="search" placeholder="Recherche..." onkeyup="renderTable()" style="width: 150px;">
            </div>

            <div id="filters-users" style="display:flex; gap:15px; flex-wrap:wrap;">
                <label class="filter-label"><input type="checkbox" onchange="toggleFilter('premium')"> <span>Premium</span></label>
                <label class="filter-label"><input type="checkbox" onchange="toggleFilter('subscriber')"> <span>Abonnés</span></label>
                <label class="filter-label"><input type="checkbox" onchange="toggleFilter('basic')"> <span>Basics</span></label>
                <label class="filter-label"><input type="checkbox" onchange="toggleFilter('connected_today')"> <span>Connecté Aujourd'hui</span></label>
            </div>

            <div id="filters-tags" class="hidden" style="display:flex; gap:15px;">
                <label class="filter-label"><input type="checkbox" onchange="toggleFilter('claimed')"> <span>Claimed</span></label>
                <label class="filter-label"><input type="checkbox" onchange="toggleFilter('unclaimed')"> <span>Unclaimed</span></label>
            </div>

            <div style="margin-left:auto; display:flex; gap:5px;">
                <span>Tri:</span>
                <select id="sort-select" onchange="renderTable()">
                    </select>
                <button onclick="toggleSort()">▼</button>
            </div>
        </div>

        <table>
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
        </table>

    </div>

    <script src="js/config.js"></script>
    <script>
        // --- AUTH & INIT ---
        const ADMIN_KEY_KEY = 'admin_key_v3';
        let ADMIN_PASS = localStorage.getItem(ADMIN_KEY_KEY);

        if(ADMIN_PASS) {
            document.getElementById('login-overlay').classList.add('hidden');
            loadData();
        }

        async function login() {
            const p = document.getElementById('admin-pass').value;
            // Test auth rapide
            try {
                const res = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({password:p})
                });
                if(res.ok) {
                    ADMIN_PASS = p;
                    localStorage.setItem(ADMIN_KEY_KEY, p);
                    document.getElementById('login-overlay').classList.add('hidden');
                    loadData();
                } else alert("INVALID PASSWORD");
            } catch(e) { alert("CONNECTION ERROR"); }
        }

        function logout() {
            localStorage.removeItem(ADMIN_KEY_KEY);
            location.reload();
        }

        // --- DATA ---
        let rawUsers = [], rawTags = [];
        let view = 'users'; // 'users' or 'tags'
        let filters = new Set();
        let sortDir = 1; // 1 asc, -1 desc

        async function loadData() {
            if(!ADMIN_PASS) return;
            document.getElementById('tbody').innerHTML = '<tr><td colspan="8" style="text-align:center">Loading data...</td></tr>';
            
            // Stats
            fetch(`${API_URL}/api/admin/stats`, {headers:{'X-Admin-Pass': ADMIN_PASS}})
                .then(r=>r.json()).then(renderStats).catch(e=>console.error(e));
            
            // Users
            fetch(`${API_URL}/api/admin/users`, {headers:{'X-Admin-Pass': ADMIN_PASS}})
                .then(r=>r.json()).then(data => {
                    // Mapper proprement
                    const map = new Map();
                    data.forEach(r => {
                        if(!map.has(r.id)) map.set(r.id, { ...r, tags: [] });
                        if(r.brawl_tag) map.get(r.id).tags.push({ 
                            id: r.tag_id, str: r.brawl_tag, interval: r.rec_temp, 
                            last: r.last_archive, total: r.total_archives || 0
                        });
                    });
                    rawUsers = Array.from(map.values());
                    if(view === 'users') renderTable();
                });

            // Tags
            fetch(`${API_URL}/api/admin/tags`, {headers:{'X-Admin-Pass': ADMIN_PASS}})
                .then(r=>r.json()).then(data => {
                    rawTags = data;
                    if(view === 'tags') renderTable();
                });
        }

        // --- LOGIQUE VUE & TRI ---
        function setView(v) {
            view = v;
            document.getElementById('btn-users').className = v==='users'?'active':'';
            document.getElementById('btn-tags').className = v==='tags'?'active':'';
            
            document.getElementById('filters-users').className = v==='users'?'':'hidden';
            document.getElementById('filters-tags').className = v==='tags'?'':'hidden';
            
            // Reset filtres
            filters.clear();
            document.querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false);
            
            // Update Sort Options
            const sel = document.getElementById('sort-select');
            sel.innerHTML = '';
            if(v === 'users') {
                sel.innerHTML += '<option value="id">ID</option>';
                sel.innerHTML += '<option value="name">Nom (Alpha)</option>';
                sel.innerHTML += '<option value="last_login">Dernière Connexion</option>';
                sel.innerHTML += '<option value="nb_archives">Nombre d\'archives</option>';
                sel.innerHTML += '<option value="nb_tags">Nombre de Tags</option>';
            } else {
                sel.innerHTML += '<option value="id">ID</option>';
                sel.innerHTML += '<option value="owner">Nom Propriétaire</option>';
                sel.innerHTML += '<option value="next_archive">Prochaine Archive</option>';
                sel.innerHTML += '<option value="last_archive">Dernière Archive</option>';
                sel.innerHTML += '<option value="nb_archives">Nombre d\'archives</option>';
                sel.innerHTML += '<option value="trophies">Nombre de Trophées</option>';
            }
            renderTable();
        }

        function toggleFilter(f) {
            if(filters.has(f)) filters.delete(f); else filters.add(f);
            renderTable();
        }
        function toggleSort() { sortDir *= -1; renderTable(); }

        // --- PROCESSING CORE ---
        function getProcessedData() {
            let data = [];
            const search = document.getElementById('search').value.toLowerCase();
            const now = new Date();

            if(view === 'users') {
                // Copie
                data = rawUsers.map(u => ({...u})); // Shallow copy

                // 1. Recherche
                if(search) data = data.filter(u => u.username.toLowerCase().includes(search) || u.id.toString().includes(search));

                // 2. Filtres
                // Logique: Si un filtre de TYPE est coché, on filtre. Si PLUSIEURS types sont cochés, c'est inclusif (OR).
                // Si filtre d'ETAT est coché, c'est restrictif (AND).
                
                const typeFilters = ['premium', 'subscriber', 'basic'];
                const hasTypeFilter = typeFilters.some(f => filters.has(f));
                
                if(hasTypeFilter) {
                    data = data.filter(u => {
                        if(filters.has('premium') && u.tier === 'premium') return true;
                        if(filters.has('subscriber') && u.tier === 'subscriber') return true;
                        if(filters.has('basic') && u.tier === 'basic') return true;
                        return false;
                    });
                }

                if(filters.has('connected_today')) data = data.filter(u => u.last_login && (now - new Date(u.last_login) < 86400000));

                // 3. Tri
                const crit = document.getElementById('sort-select').value;
                data.sort((a,b) => {
                    let vA, vB;
                    if(crit === 'id') { vA = a.id; vB = b.id; }
                    else if(crit === 'name') { vA = a.username.toLowerCase(); vB = b.username.toLowerCase(); }
                    else if(crit === 'last_login') { vA = a.last_login || ''; vB = b.last_login || ''; }
                    else if(crit === 'nb_archives') { 
                        vA = a.tags.reduce((s,t)=>s+t.total,0); 
                        vB = b.tags.reduce((s,t)=>s+t.total,0); 
                    }
                    else if(crit === 'nb_tags') { vA = a.tags.length; vB = b.tags.length; }
                    
                    if(vA < vB) return -1 * sortDir;
                    if(vA > vB) return 1 * sortDir;
                    return 0;
                });

            } else {
                // TAGS VIEW
                data = rawTags.map(t => ({...t}));

                if(search) data = data.filter(t => t.tag_str.toLowerCase().includes(search) || (t.owner_name && t.owner_name.toLowerCase().includes(search)));

                if(filters.has('claimed')) data = data.filter(t => t.claimer_id);
                if(filters.has('unclaimed')) data = data.filter(t => !t.claimer_id);

                const crit = document.getElementById('sort-select').value;
                data.sort((a,b) => {
                    let vA, vB;
                    if(crit === 'id') { vA = a.tag_str; vB = b.tag_str; }
                    else if(crit === 'owner') { vA = a.owner_name ? a.owner_name.toLowerCase() : 'zzzz'; vB = b.owner_name ? b.owner_name.toLowerCase() : 'zzzz'; }
                    else if(crit === 'last_archive') { vA = a.last_archive || ''; vB = b.last_archive || ''; }
                    else if(crit === 'nb_archives') { vA = a.total_archives; vB = b.total_archives; }
                    else if(crit === 'trophies') { vA = a.current_trophies || 0; vB = b.current_trophies || 0; }
                    else if(crit === 'next_archive') {
                        const getNext = (t) => t.last_archive ? new Date(t.last_archive.replace(' ', 'T')).getTime() + (t.rec_temp*60000) : 0;
                        vA = getNext(a); vB = getNext(b);
                    }

                    if(vA < vB) return -1 * sortDir;
                    if(vA > vB) return 1 * sortDir;
                    return 0;
                });
            }
            return data;
        }

        // --- RENDER ---
        function renderTable() {
            const tbody = document.getElementById('tbody');
            const thead = document.getElementById('thead');
            tbody.innerHTML = '';
            
            const data = getProcessedData();

            if(view === 'users') {
                thead.innerHTML = `<tr><th>+</th><th>ID</th><th>NOM</th><th>GRADE</th><th>CONNEXION</th><th>TAGS</th><th>TOTAL ARCH.</th><th>ACTIONS</th></tr>`;
                
                data.forEach(u => {
                    const row = document.createElement('tr');
                    const totTags = u.tags.length;
                    const totArch = u.tags.reduce((acc, t) => acc + t.total, 0);
                    
                    row.innerHTML = `
                        <td><button style="padding:0 5px" onclick="toggleDetails(${u.id})">▼</button></td>
                        <td>${u.id}</td>
                        <td style="font-weight:bold; color:#fff">${u.username}</td>
                        <td>
                            <select onchange="updateTier(${u.id}, this.value)" style="padding:0;">
                                <option value="basic" ${u.tier==='basic'?'selected':''}>Basic</option>
                                <option value="subscriber" ${u.tier==='subscriber'?'selected':''}>Subscriber</option>
                                <option value="premium" ${u.tier==='premium'?'selected':''}>Premium</option>
                            </select>
                        </td>
                        <td>${u.last_login || '-'}</td>
                        <td>${totTags}</td>
                        <td>${totArch}</td>
                        <td>
                            <button onclick="addTag(${u.id})" class="btn-green">+</button>
                            <button onclick="renameUser(${u.id}, '${u.username}')">R</button>
                            <button onclick="deleteUser(${u.id})" class="btn-red">X</button>
                        </td>
                    `;
                    tbody.appendChild(row);

                    // Tags Details
                    if(totTags > 0) {
                        const dr = document.createElement('tr');
                        dr.id = `d-${u.id}`;
                        dr.className = 'hidden details-row';
                        let h = '<td colspan="8"><table class="details-table" style="width:90%; margin:auto;">';
                        u.tags.forEach(t => {
                            h += `<tr>
                                <td style="width:20px;">↳</td>
                                <td class="badge">${t.str}</td>
                                <td>Freq: <input type="number" value="${t.interval}" style="width:40px; text-align:center" onchange="updFreq(${t.id}, this)">m</td>
                                <td>Last: ${t.last || 'Never'}</td>
                                <td>Arch: ${t.total}</td>
                                <button onclick="window.location.href='admin_edit.html?tag_id=${t.id}'" class="btn-red">EDIT</button>
                                <td style="text-align:right"><button onclick="unclaim(${t.id})" class="btn-red">UNCLAIM</button></td>
                            </tr>`;
                        });
                        h += '</table></td>';
                        dr.innerHTML = h;
                        tbody.appendChild(dr);
                    }
                });
            } else {
                // TAGS
                thead.innerHTML = `<tr><th>PROPRIÉTAIRE</th><th>TAG</th><th>FREQ</th><th>LAST ARCH.</th><th>NEXT ARCH.</th><th>TROPHÉES</th><th>ARCHIVES</th><th>ACTIONS</th></tr>`;
                
                data.forEach(t => {
                    const row = document.createElement('tr');
                    const owner = t.owner_name ? `<span style="color:#fff; font-weight:bold">${t.owner_name}</span>` : '<span style="color:#555">-- UNCLAIMED --</span>';
                    
                    // Calcul Next
                    let nextStr = '-';
                    if(t.last_archive) {
                        const d = new Date(t.last_archive.replace(' ', 'T')).getTime();
                        const n = d + (t.rec_temp * 60000);
                        const diff = Math.ceil((n - Date.now()) / 60000);
                        nextStr = diff > 0 ? diff + ' min' : 'Maintenant';
                    }

                    row.innerHTML = `
                        <td>${owner}</td>
                        <td class="badge">${t.tag_str}</td>
                        <td><input type="number" value="${t.rec_temp}" style="width:50px" onchange="updFreq(${t.id}, this)"></td>
                        <td>${t.last_archive || '-'}</td>
                        <td>${nextStr}</td>
                        <td style="color:#ffce00">${t.current_trophies || 0}</td>
                        <td>${t.total_archives}</td>
                        <td>
                            <button onclick="window.location.href='admin_edit.html?tag_id=${t.id}'" class="btn-red">EDIT</button>
                            ${t.claimer_id ? `<button onclick="unclaim(${t.id})" class="btn-red">UNCLAIM</button>` : ''}
                            <button onclick="delTag(${t.id})" class="btn-red">DEL</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function renderStats(d) {
            const h = document.getElementById('stats-area');
            h.innerHTML = `
                <div class="stat-box"><h3>USERS</h3><p>${d.users}</p></div>
                <div class="stat-box"><h3>ARCHIVES</h3><p>${d.records}</p></div>
                <div class="stat-box"><h3>TAGS (C/T)</h3><p>${d.claimed_tags}/${d.total_tags}</p></div>
                <div class="stat-box"><h3>STORAGE</h3><p>${d.disk_str}</p></div>
                <div class="stat-box"><h3>LAST ARCH.</h3><p style="font-size:0.9em">${d.last_archive_date||'-'}</p></div>
                <div class="stat-box"><h3>NEXT ARCH.</h3><p style="color:#28a745; font-size:0.9em">${d.next_archive_date||'-'}</p></div>
                <div class="stat-box"><h3>CPU</h3><p>${d.cpu}%</p></div>
                <div class="stat-box"><h3>RAM</h3><p>${d.ram}%</p></div>
            `;
        }

        // --- ACTIONS ---
        function toggleDetails(id) { const r=document.getElementById('d-'+id); if(r) r.classList.toggle('hidden'); }
        
        async function api(url, method='POST', body={}) {
            const res = await fetch(`${API_URL}/api/admin/${url}`, {
                method: method, headers:{'Content-Type':'application/json', 'X-Admin-Pass':ADMIN_PASS}, body:JSON.stringify(body)
            });
            if(res.ok) { loadData(); return true; }
            else { alert("ERROR"); return false; }
        }

        function renameUser(id, old) { const n=prompt("Name:", old); if(n && n!==old) api(`user/${id}/rename`, 'POST', {username:n}); }
        function addTag(id) { const t=prompt("Tag (#...):"); if(t) api(`user/${id}/claim`, 'POST', {tag:t}); }
        function deleteUser(id) { if(confirm("Supprimer User ?")) alert("Backend Impl needed"); } // A implémenter backend
        function unclaim(tid) { if(confirm("Unclaim Tag ?")) api(`tag/${tid}/unclaim`); }
        function delTag(tid) { if(confirm("DELETE TAG DEFINITELY?")) fetch(`${API_URL}/api/admin/tag/${tid}`, {method:'DELETE', headers:{'X-Admin-Pass':ADMIN_PASS}}).then(loadData); }
        function updateTier(uid, tier) { api(`update-tier`, 'POST', {user_id:uid, tier:tier}); }
        function updFreq(tid, el) { 
            api(`tag/${tid}/frequency`, 'POST', {minutes: el.value}).then(ok => el.style.borderColor = ok?'green':'red'); 
        }

        // Init view
        setView('users');
    </script>
</body>
</html>
