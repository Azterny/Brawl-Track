<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Brawl Track</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <style>
        /* Styles sp√©cifiques Admin (Grid Stats) */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            text-align: center;
        }
        .stat-card h3 {
            font-size: 0.85em;
            color: #aaa;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-card p {
            font-size: 1.4em;
            font-weight: bold;
            color: #fff;
            margin: 0;
        }
        
        /* Contr√¥les & Tables */
        .controls-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: #181818;
            padding: 10px;
            border-radius: 8px;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #252525;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        select, input[type="text"] {
            background: #111;
            color: #fff;
            border: 1px solid #444;
            padding: 5px;
            border-radius: 4px;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #111; color: #888; font-size: 0.9em; }
        tr:hover { background: #1a1a1a; }
        
        /* Boutons Actions */
        .action-btn { background: #333; border: none; color: #fff; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: 0.2s; }
        .action-btn:hover { background: #555; }
        .btn-add { background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-add:hover { background: #218838; }
        .btn-del { background: #444; color: #ff5555; border: 1px solid #ff5555; border-radius: 4px; cursor: pointer; padding: 2px 6px; }
        .btn-del:hover { background: #ff5555; color: white; }
        
        .badge-tag { background: #222; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; font-family: monospace; color: #ffce00; }
        .details-row { background: #151515 !important; }
        .hidden { display: none; }
        
        /* Switch Mode Vue */
        .view-switch {
            display: flex;
            background: #111;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #444;
        }
        .view-btn {
            padding: 6px 12px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #888;
        }
        .view-btn.active {
            background: #333;
            color: #fff;
            font-weight: bold;
        }
    </style>
</head>
<body style="background-color: #0a0a0a; color: #e0e0e0; font-family: sans-serif; padding: 20px;">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="color: #ffce00; margin: 0;">üõ°Ô∏è Administration</h1>
        <div>
            <button onclick="loadData()" style="padding: 8px 15px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer;">Actualiser</button>
            <button onclick="logout()" style="padding: 8px 15px; background: #8b0000; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Quitter</button>
        </div>
    </div>

    <div id="stats-container">Chargement des statistiques...</div>

    <div class="controls-bar">
        <div class="view-switch">
            <button class="view-btn active" id="btn-view-users" onclick="switchView('users')">Utilisateurs</button>
            <button class="view-btn" id="btn-view-tags" onclick="switchView('tags')">Tous les Tags</button>
        </div>

        <div class="filter-group">
            <span>üîç</span>
            <input type="text" id="search-input" placeholder="Rechercher..." onkeyup="renderTable()">
        </div>

        <div class="filter-group">
            <span>Filtres:</span>
            <label><input type="checkbox" onchange="toggleFilter('premium')"> Premium</label>
            <label><input type="checkbox" onchange="toggleFilter('active_24h')"> Actif 24h</label>
            <label id="filter-unclaimed-wrapper" class="hidden"><input type="checkbox" onchange="toggleFilter('unclaimed')"> Non Claim</label>
            <label id="filter-claimed-wrapper" class="hidden"><input type="checkbox" onchange="toggleFilter('claimed')"> Claimed</label>
        </div>

        <div style="margin-left: auto; display: flex; gap: 10px;">
            <select id="sort-select" onchange="renderTable()">
                <option value="id">ID / Alpha</option>
                <option value="last_archive">Derni√®re Archive</option>
                <option value="next_archive">Prochaine Archive</option>
                <option value="total_archives">Nb Archives</option>
                <option value="trophies">Troph√©es</option>
                <option value="owner">Propri√©taire</option>
            </select>
            <button onclick="toggleSortOrder()" id="sort-order-btn" style="background:#333; color:white; border:1px solid #555;">‚ñº</button>
        </div>
    </div>

    <table id="main-table">
        <thead id="table-head"></thead>
        <tbody id="table-body"></tbody>
    </table>

    <script src="js/config.js"></script>
    <script>
        const ADMIN_KEY = localStorage.getItem('admin_key');
        if (!ADMIN_KEY) {
            const pass = prompt("Mot de passe Admin :");
            // V√©rification basique locale avant appel API (facultatif mais UX)
            if(pass) {
                localStorage.setItem('admin_key', pass);
                window.location.reload();
            } else {
                document.body.innerHTML = "<h2 style='color:red'>Acc√®s Refus√©</h2>";
            }
        }

        // --- GLOBAL VARIABLES ---
        let rawUsersData = [];
        let rawTagsData = []; // Liste ind√©pendante des tags
        let currentFilters = new Set();
        let sortOrder = 1; // 1 = ASC, -1 = DESC
        let currentView = 'users'; // 'users' ou 'tags'

        // --- INIT ---
        loadData();

        // --- NAVIGATION ---
        function switchView(mode) {
            currentView = mode;
            document.getElementById('btn-view-users').className = mode === 'users' ? 'view-btn active' : 'view-btn';
            document.getElementById('btn-view-tags').className = mode === 'tags' ? 'view-btn active' : 'view-btn';
            
            // Affichage filtres contextuels
            if(mode === 'tags') {
                document.getElementById('filter-unclaimed-wrapper').classList.remove('hidden');
                document.getElementById('filter-claimed-wrapper').classList.remove('hidden');
            } else {
                document.getElementById('filter-unclaimed-wrapper').classList.add('hidden');
                document.getElementById('filter-claimed-wrapper').classList.add('hidden');
            }

            renderTable();
        }

        function logout() {
            localStorage.removeItem('admin_key');
            window.location.href = 'index.html';
        }

        // --- LOAD DATA ---
        function loadData() {
            loadStats();
            loadUsersList();
            loadTagsList();
        }

        async function loadStats() {
            try {
                // IMPORTANT: Requ√™te sur le port 5001 (via Cloudflare /api/admin)
                const res = await fetch(`${API_URL}/api/admin/stats`, { headers: { 'X-Admin-Pass': ADMIN_KEY } });
                if (res.status === 403) throw new Error("Auth Failed");
                const data = await res.json();
                renderStats(data);
            } catch (e) {
                console.error(e);
                if(e.message === "Auth Failed") {
                    localStorage.removeItem('admin_key');
                    window.location.reload();
                }
            }
        }

        async function loadUsersList() {
            try {
                const res = await fetch(`${API_URL}/api/admin/users`, { headers: { 'X-Admin-Pass': ADMIN_KEY } });
                const rawApiData = await res.json();
                
                // Groupement des tags par user
                const map = new Map();
                rawApiData.forEach(row => {
                    if (!map.has(row.id)) {
                        map.set(row.id, {
                            id: row.id, username: row.username, tier: row.tier, last_login: row.last_login, 
                            user_interval: row.user_default_interval, tags: []
                        });
                    }
                    if (row.brawl_tag) {
                        map.get(row.id).tags.push({
                            id: row.tag_id,
                            tag_str: row.brawl_tag,
                            interval: row.rec_temp,
                            last_archive: row.last_archive,
                            total_archives: row.total_archives || 0,
                            trophies: 0 
                        });
                    }
                });
                rawUsersData = Array.from(map.values());
                if(currentView === 'users') renderTable();
            } catch(e) { console.error("Err Users", e); }
        }

        async function loadTagsList() {
            try {
                const res = await fetch(`${API_URL}/api/admin/tags`, { headers: { 'X-Admin-Pass': ADMIN_KEY } });
                rawTagsData = await res.json();
                if(currentView === 'tags') renderTable();
            } catch(e) { console.error("Err Tags", e); }
        }

        // --- RENDER STATS (Layout 2x4) ---
        function renderStats(data) {
            const container = document.getElementById('stats-container');
            
            // Calcul temps restant
            let nextArchiveText = "En attente...";
            let nextArchiveColor = "#888";
            if (data.next_archive_date) {
                const now = new Date();
                const target = new Date(data.next_archive_date.replace(' ', 'T')); // Hack simple parsing SQL
                const diffMs = target - now;
                const diffMins = Math.ceil(diffMs / 60000);

                if (diffMins <= 0) {
                    nextArchiveText = "Imminent";
                    nextArchiveColor = "#ffce00";
                } else {
                    nextArchiveText = `dans ${diffMins} min`;
                    nextArchiveColor = "#28a745";
                }
            }
            const lastArchText = data.last_archive_date ? formatDate(data.last_archive_date) : "Aucune";

            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Utilisateurs Inscrits</h3>
                        <p>${data.users}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Points d'Historique</h3>
                        <p>${data.records}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Moy. Archives/User</h3>
                        <p>${data.avg_archives}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Tags (Claim / Total)</h3>
                        <p>${data.claimed_tags} <span style="font-size:0.6em; color:#888;">/ ${data.total_tags}</span></p>
                    </div>

                    <div class="stat-card">
                        <h3>Derni√®re Archive</h3>
                        <p style="font-size:0.9em">${lastArchText}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Prochaine Auto</h3>
                        <p style="color:${nextArchiveColor}">${nextArchiveText}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Stockage (Utilis√©/Max)</h3>
                        <p style="font-size:0.8em">${data.disk_str} <span style="font-size:0.8em; color:${data.disk_percent > 80 ? '#ff5555' : '#888'}">(${data.disk_percent}%)</span></p>
                    </div>
                    <div class="stat-card">
                        <h3>Charge CPU / RAM</h3>
                        <div style="font-size: 0.8rem; text-align: left; margin-top: 5px; padding-left: 20px;">
                            CPU: <div style="display:inline-block; width:60px; height:8px; background:#333; border-radius:4px;">
                                    <div style="width:${data.cpu}%; height:100%; background:${getColor(data.cpu)}; border-radius:4px;"></div>
                                 </div> ${data.cpu}%<br>
                            RAM: <div style="display:inline-block; width:60px; height:8px; background:#333; border-radius:4px; margin-top:3px;">
                                    <div style="width:${data.ram}%; height:100%; background:${getColor(data.ram)}; border-radius:4px;"></div>
                                 </div> ${data.ram}%
                        </div>
                    </div>
                </div>
            `;
        }

        // --- RENDER TABLE MAIN ---
        function renderTable() {
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            const data = getProcessedData(currentView);

            if (currentView === 'users') renderUsersTable(data, thead, tbody);
            else renderTagsTable(data, thead, tbody);
        }

        // --- VUE UTILISATEURS ---
        function renderUsersTable(data, thead, tbody) {
            thead.innerHTML = `<tr><th style="width:30px"></th><th>ID</th><th>Utilisateur</th><th>Grade</th><th>Derni√®re Connexion</th><th>Total Archives</th><th style="text-align:right">Actions</th></tr>`;
            
            data.forEach(u => {
                const row = document.createElement('tr');
                const lastLog = u.last_login ? formatDate(u.last_login) : 'Jamais';
                const totArch = u.tags.reduce((acc, t) => acc + t.total_archives, 0);

                // Ligne Principale
                row.innerHTML = `
                    <td><button class="action-btn" onclick="toggleDetails(${u.id})">‚ñº</button></td>
                    <td style="color:#888">#${u.id}</td>
                    <td style="font-weight:bold; color:white">${u.username}</td>
                    <td><select onchange="updateTier(${u.id}, this.value)" style="padding:2px;">
                        <option value="basic" ${u.tier==='basic'?'selected':''}>Basic</option>
                        <option value="subscriber" ${u.tier==='subscriber'?'selected':''}>Abonn√©</option>
                        <option value="premium" ${u.tier==='premium'?'selected':''}>Premium</option>
                    </select></td>
                    <td style="color:#aaa; font-size:0.9em">${lastLog}</td>
                    <td><span style="color:#ffce00">${totArch}</span></td>
                    <td style="text-align:right; display:flex; gap:5px; justify-content:flex-end;">
                        <button class="action-btn" title="Renommer" onclick="renameUser(${u.id}, '${u.username}')">‚úèÔ∏è</button>
                        <button class="btn-add" title="Ajouter un Tag" onclick="adminAddTag(${u.id})">‚ûï</button>
                        <button class="btn-del" title="Supprimer User" onclick="deleteUser(${u.id})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);

                // Ligne D√©tails (Tags)
                const detailRow = document.createElement('tr');
                detailRow.id = `detail-${u.id}`;
                detailRow.className = 'hidden details-row';
                
                let tagsHtml = u.tags.map(t => `
                    <tr style="background:transparent;">
                        <td colspan="2" style="text-align:right">‚Ü≥</td>
                        <td><span class="badge-tag">${t.tag_str}</span></td>
                        <td>
                            <input type="number" value="${t.interval}" 
                                style="width:50px; background:#111; color:#ffce00; border:1px solid #444; border-radius:4px; text-align:center;" 
                                onchange="updateTagFreq(${t.id}, this)" title="Freq (min)"> min
                        </td>
                        <td>Last: ${t.last_archive ? formatDate(t.last_archive) : 'N/A'}</td>
                        <td style="color:#aaa">Next: ${getNextTime(t.last_archive, t.interval)}</td>
                        <td style="text-align:right">
                            <button class="action-btn" onclick="window.location.href='admin_edit.html?id=${u.id}'">üìù</button>
                            <button class="btn-del" title="D√©tacher" onclick="adminUnclaimTag(${t.id})">üîó‚úñ</button>
                        </td>
                    </tr>
                `).join('');

                if(!tagsHtml) tagsHtml = `<tr><td colspan="7" style="text-align:center; color:#666; font-style:italic;">Aucun tag associ√©</td></tr>`;

                detailRow.innerHTML = `<td colspan="7"><table style="width:95%; margin:auto; background:#222; border-radius:4px;">${tagsHtml}</table></td>`;
                tbody.appendChild(detailRow);
            });
        }

        // --- VUE TAGS ---
        function renderTagsTable(data, thead, tbody) {
            thead.innerHTML = `<tr><th>Propri√©taire</th><th>Tag</th><th>Freq</th><th>Last Arch.</th><th>Next Arch.</th><th>Troph√©es</th><th style="text-align:right">Actions</th></tr>`;
            
            if(data.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px">Aucun r√©sultat</td></tr>`; 
                return; 
            }
            
            data.forEach(item => {
                const u = item.user;
                const t = item.tag;
                
                const ownerDisplay = u 
                    ? `<span style="font-weight:bold; color:white;">${u.username}</span>` 
                    : `<span style="color:#666; font-style:italic;">-- Unclaimed --</span>`;
                    
                const editBtn = u
                    ? `<button class="action-btn" onclick="window.location.href='admin_edit.html?id=${u.id}'" title="Edit">üìù</button>`
                    : `<button class="action-btn" style="opacity:0.3; cursor:not-allowed;">üìù</button>`;

                const unclaimBtn = u
                    ? `<button class="btn-del" onclick="adminUnclaimTag(${t.id})" title="D√©tacher">üîó‚úñ</button>`
                    : ``;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ownerDisplay}</td>
                    <td><span class="badge-tag">${t.tag_str}</span></td>
                    <td>
                        <input type="number" value="${t.interval}" 
                               style="width:60px; background:#111; color:#ffce00; border:1px solid #444; border-radius:4px; text-align:center; padding:5px;" 
                               onchange="updateTagFreq(${t.id}, this)"> min
                    </td>
                    <td>${t.last_archive ? formatDate(t.last_archive) : 'N/A'}</td>
                    <td>${getNextTime(t.last_archive, t.interval)}</td>
                    <td style="color:#ffce00; font-weight:bold;">${t.trophies || 0} üèÜ</td>
                    <td style="text-align:right">
                        ${editBtn}
                        ${unclaimBtn}
                        <button class="btn-del" style="background:#8b0000; border:1px solid #ff5555;" onclick="adminDeleteTag(${t.id})">üóëÔ∏è Tag</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- ACTIONS ADMIN ---

        async function renameUser(uid, currentName) {
            const newName = prompt("Nouveau pseudo :", currentName);
            if (!newName || newName === currentName) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/user/${uid}/rename`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Pass': ADMIN_KEY },
                    body: JSON.stringify({ username: newName })
                });
                if(res.ok) { alert("‚úÖ Renomm√©"); loadUsersList(); }
                else alert("Erreur");
            } catch(e) { alert("Erreur r√©seau"); }
        }

        async function adminAddTag(uid) {
            const tag = prompt("Tag √† ajouter (ex: #ABC) :");
            if (!tag) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/user/${uid}/claim`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Pass': ADMIN_KEY },
                    body: JSON.stringify({ tag: tag })
                });
                const d = await res.json();
                alert(d.message);
                if(res.ok) loadUsersList();
            } catch(e) { alert("Erreur r√©seau"); }
        }

        async function adminUnclaimTag(tagId) {
            if (!confirm("D√©tacher ce tag ? (Arr√™t des archives)")) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/tag/${tagId}/unclaim`, {
                    method: 'POST', headers: { 'X-Admin-Pass': ADMIN_KEY }
                });
                if(res.ok) { loadData(); }
            } catch(e) { alert("Erreur"); }
        }

        async function adminDeleteTag(tagId) {
            if (!confirm("‚ö†Ô∏è SUPPRIMER D√âFINITIVEMENT CE TAG ET TOUT SON HISTORIQUE ?")) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/tag/${tagId}`, {
                    method: 'DELETE', headers: { 'X-Admin-Pass': ADMIN_KEY }
                });
                if(res.ok) { alert("Tag Supprim√©"); loadData(); }
            } catch(e) { alert("Erreur"); }
        }

        async function updateTagFreq(tagId, input) {
            const val = parseInt(input.value);
            if(isNaN(val) || val < 0) return;
            input.style.borderColor = "#ffce00";
            try {
                const res = await fetch(`${API_URL}/api/admin/tag/${tagId}/frequency`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Pass': ADMIN_KEY },
                    body: JSON.stringify({ minutes: val })
                });
                if(res.ok) { 
                    input.style.borderColor = "#28a745";
                    setTimeout(() => input.style.borderColor = "#444", 1000);
                } else input.style.borderColor = "red";
            } catch(e) { input.style.borderColor = "red"; }
        }

        async function updateTier(uid, tier) {
            try {
                const res = await fetch(`${API_URL}/api/admin/update-tier`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Pass': ADMIN_KEY },
                    body: JSON.stringify({ user_id: uid, tier: tier })
                });
                if(res.ok) loadUsersList();
            } catch(e) { console.error(e); }
        }

        async function deleteUser(uid) {
            if(!confirm("Supprimer l'utilisateur et d√©tacher ses tags ?")) return;
            // Note: Impl√©menter la route DELETE /api/admin/user/<id> si pas d√©j√† fait dans main.py
            alert("Fonctionnalit√© √† impl√©menter c√¥t√© backend si n√©cessaire."); 
        }

        // --- PROCESSING & UTILS ---
        
        function getProcessedData(mode) {
            let data = [];
            const search = document.getElementById('search-input').value.toLowerCase();
            const now = new Date();

            if (mode === 'users') {
                data = rawUsersData.filter(u => 
                    u.username.toLowerCase().includes(search) || 
                    u.tags.some(t => t.tag_str.toLowerCase().includes(search))
                );
                // Filtre Premium etc.
                if (currentFilters.has('premium')) data = data.filter(u => u.tier === 'premium');
                if (currentFilters.has('active_24h')) data = data.filter(u => u.last_login && (now - new Date(u.last_login)) < 86400000);
                
                // Tri Users
                const crit = document.getElementById('sort-select').value;
                data.sort((a,b) => {
                    let vA = a.username.toLowerCase(), vB = b.username.toLowerCase();
                    if(crit === 'last_archive') { vA = 0; vB = 0; /* Pas pertinent sur user global */ } 
                    // Ajoute tes logiques de tri ici si besoin
                    return (vA < vB ? -1 : 1) * sortOrder;
                });

            } else {
                // Mode TAGS
                data = rawTagsData.map(t => ({
                    user: t.owner_id ? { id: t.owner_id, username: t.owner_name } : null,
                    tag: {
                        id: t.id, tag_str: t.tag_str, interval: t.rec_temp,
                        last_archive: t.last_archive, total_archives: t.total_archives,
                        trophies: t.current_trophies || 0
                    }
                }));

                // Filtres Tags
                data = data.filter(item => {
                    if (search && !item.tag.tag_str.toLowerCase().includes(search) && !(item.user && item.user.username.toLowerCase().includes(search))) return false;
                    if (currentFilters.has('claimed') && !item.user) return false; 
                    if (currentFilters.has('unclaimed') && item.user) return false;
                    return true;
                });

                // Tri Tags
                const crit = document.getElementById('sort-select').value;
                data.sort((a, b) => {
                    let vA, vB;
                    const tA = a.tag, tB = b.tag;
                    if (crit === 'id') { vA = tA.tag_str; vB = tB.tag_str; }
                    else if (crit === 'trophies') { vA = tA.trophies; vB = tB.trophies; }
                    else if (crit === 'next_archive') {
                         vA = tA.last_archive ? new Date(tA.last_archive).getTime() + (tA.interval*60000) : 0;
                         vB = tB.last_archive ? new Date(tB.last_archive).getTime() + (tB.interval*60000) : 0;
                    }
                    else if (crit === 'owner') { 
                        vA = a.user ? a.user.username : 'zzz'; 
                        vB = b.user ? b.user.username : 'zzz'; 
                    }
                    else { vA = tA.last_archive || ''; vB = tB.last_archive || ''; } // Default Last Arch
                    
                    if (vA < vB) return -1 * sortOrder;
                    if (vA > vB) return 1 * sortOrder;
                    return 0;
                });
            }
            return data;
        }

        function toggleFilter(f) {
            if(currentFilters.has(f)) currentFilters.delete(f);
            else currentFilters.add(f);
            renderTable();
        }

        function toggleSortOrder() {
            sortOrder *= -1;
            document.getElementById('sort-order-btn').innerText = sortOrder === 1 ? '‚ñº' : '‚ñ≤';
            renderTable();
        }

        function toggleDetails(uid) {
            const row = document.getElementById(`detail-${uid}`);
            if(row) row.classList.toggle('hidden');
        }

        // --- UTILS ---
        function formatDate(str) {
            if(!str) return 'N/A';
            const d = new Date(str.replace(' ', 'T'));
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }

        function getNextTime(lastStr, interval) {
            if(!lastStr || !interval) return 'Pause';
            const next = new Date(new Date(lastStr.replace(' ', 'T')).getTime() + interval*60000);
            const diff = Math.round((next - new Date()) / 60000);
            if(diff < 0) return 'En retard';
            return diff + ' min';
        }

        function getColor(val) {
            if(val < 50) return '#28a745';
            if(val < 80) return '#ffce00';
            return '#ff5555';
        }
    </script>
</body>
</html>
