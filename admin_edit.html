<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Edit Tag - Brawl Track</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        body { background-color: #000; color: #ccc; font-family: monospace; margin: 0; padding: 20px; font-size: 14px; }
        
        #container { max-width: 1000px; margin: 0 auto; border: 1px solid #444; background: #111; padding: 15px; }

        /* HEADER */
        header { display: flex; justify-content: space-between; border-bottom: 2px solid #ffce00; padding-bottom: 15px; margin-bottom: 20px; }
        .title-block h1 { margin: 0; color: #fff; font-size: 1.5em; }
        .title-block h2 { margin: 5px 0 0 0; color: #ffce00; font-size: 1.1em; }
        
        /* CONTROLS */
        .controls { background: #222; padding: 10px; display: flex; gap: 10px; margin-bottom: 15px; border: 1px solid #333; }
        select, button, input { background: #000; color: #fff; border: 1px solid #555; padding: 5px 10px; cursor: pointer; font-family: monospace; }
        button:hover { background: #333; }
        .btn-green { color: #28a745; border-color: #28a745; }
        .btn-red { color: #ff5555; border-color: #ff5555; }

        /* CHART */
        #chart-container { background: #080808; border: 1px solid #333; padding: 10px; height: 300px; margin-bottom: 20px; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; border-bottom: 2px solid #444; padding: 5px; color: #888; }
        td { border-bottom: 1px solid #222; padding: 5px; }
        tr:hover { background: #1a1a1a; }
        
        .loading { text-align: center; padding: 20px; color: #888; }
    </style>
</head>
<body>

<div id="container">
    <header>
        <div class="title-block">
            <h1 id="owner-name">Chargement...</h1>
            <h2 id="tag-str">#...</h2>
        </div>
        <button onclick="window.location.href='admin.html'">[ RETOUR ]</button>
    </header>

    <div id="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <div class="controls">
        <span>Affichage :</span>
        <select id="view-select" onchange="loadHistory()">
            <option value="global">GLOBAL (Utilisateur)</option>
            <option disabled>--- BRAWLERS ---</option>
            </select>
        <button onclick="addPoint()" class="btn-green">+ AJOUTER POINT</button>
        <button onclick="loadHistory()">ACTUALISER</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>DATE (UTC)</th>
                <th>TROPHÉES</th>
                <th style="text-align:right">ACTIONS</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

<script src="js/config.js"></script>
<script>
    // Récupération ID URL
    const params = new URLSearchParams(window.location.search);
    const TAG_ID = params.get('tag_id');
    const ADMIN_KEY = localStorage.getItem('admin_key_v3') || localStorage.getItem('admin_key'); // Compatibilité v2/v3

    if(!TAG_ID || !ADMIN_KEY) {
        alert("Accès non autorisé ou Tag manquant.");
        window.location.href = 'admin.html';
    }

    let chartInstance = null;
    let brawlersList = []; // {id, name} - Pour l'instant ID
    
    // Noms des Brawlers (Optionnel : Idéalement chargé depuis API, ici liste partielle ou IDs)
    // On utilisera les ID bruts si pas de mapping.

    // --- INIT ---
    async function init() {
        await loadTagDetails();
        loadHistory(); // Charge Global par défaut
    }

    // --- 1. DETAILS TAG & LISTE BRAWLERS ---
    async function loadTagDetails() {
        try {
            const res = await fetch(`${API_URL}/api/admin/tag/${TAG_ID}/details`, {
                headers: { 'X-Admin-Pass': ADMIN_KEY }
            });
            if(!res.ok) throw new Error("Erreur load details");
            const data = await res.json();

            document.getElementById('owner-name').innerText = data.owner;
            document.getElementById('tag-str').innerText = data.tag;

            // Remplir Select
            const sel = document.getElementById('view-select');
            data.brawlers.forEach(bid => {
                const opt = document.createElement('option');
                opt.value = bid;
                opt.innerText = `Brawler ID: ${bid}`; // Amélioration: Mapper ID -> Nom si possible
                sel.appendChild(opt);
            });

        } catch(e) { console.error(e); alert("Impossible de charger le tag"); }
    }

    // --- 2. HISTORIQUE & CHART ---
    async function loadHistory() {
        const view = document.getElementById('view-select').value;
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '<tr><td colspan="3" class="loading">Chargement...</td></tr>';

        let url = `${API_URL}/api/admin/tag/${TAG_ID}/history`;
        if(view !== 'global') url += `?brawler_id=${view}`;

        try {
            const res = await fetch(url, { headers: { 'X-Admin-Pass': ADMIN_KEY } });
            const data = await res.json();
            
            // Inverser pour l'affichage tableau (Plus récent en haut)
            // L'API renvoie DESC, donc c'est bon pour le tableau.
            // Pour le Chart, il faut ASC.
            renderTable(data);
            
            const chartData = [...data].reverse(); // Copie ASC pour graph
            renderChart(chartData);

        } catch(e) { tbody.innerHTML = '<tr><td colspan="3">Erreur</td></tr>'; }
    }

    function renderTable(data) {
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        const isBrawler = document.getElementById('view-select').value !== 'global';

        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.recorded_at}</td>
                <td style="color:#ffce00; font-weight:bold;">${row.trophies}</td>
                <td style="text-align:right">
                    <button onclick="editPoint(${row.id}, ${row.trophies}, ${isBrawler})">EDIT</button>
                    <button onclick="deletePoint(${row.id}, ${isBrawler})" class="btn-red">DEL</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        if(data.length === 0) tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">Aucun historique</td></tr>';
    }

    function renderChart(data) {
        const ctx = document.getElementById('myChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.recorded_at.split(' ')[0]), // Juste la date pour lisibilité
                datasets: [{
                    label: 'Trophées',
                    data: data.map(d => d.trophies),
                    borderColor: '#ffce00',
                    backgroundColor: 'rgba(255, 206, 0, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#666' }, grid: { color: '#222' } },
                    y: { ticks: { color: '#666' }, grid: { color: '#222' } }
                }
            }
        });
    }

    // --- 3. ACTIONS ---

    async function addPoint() {
        const view = document.getElementById('view-select').value;
        const val = prompt("Nombre de Trophées :");
        if(!val) return;
        
        // Date par défaut : Maintenant (Format SQL simple)
        const now = new Date().toISOString().slice(0, 19).replace('T', ' ');
        const date = prompt("Date (YYYY-MM-DD HH:MM:SS) :", now);
        if(!date) return;

        const payload = {
            tag_id: TAG_ID,
            trophies: parseInt(val),
            date: date,
            brawler_id: view === 'global' ? null : view
        };

        await sendAction('POST', payload);
    }

    async function editPoint(id, oldVal, isBrawler) {
        const newVal = prompt("Nouveaux Trophées :", oldVal);
        if(!newVal || newVal == oldVal) return;

        const payload = {
            id: id,
            trophies: parseInt(newVal),
            is_brawler: isBrawler
        };
        await sendAction('PUT', payload);
    }

    async function deletePoint(id, isBrawler) {
        if(!confirm("Supprimer ce point d'archive ?")) return;
        const payload = { id: id, is_brawler: isBrawler };
        await sendAction('DELETE', payload);
    }

    async function sendAction(method, body) {
        try {
            const res = await fetch(`${API_URL}/api/admin/point`, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'X-Admin-Pass': ADMIN_KEY },
                body: JSON.stringify(body)
            });
            const d = await res.json();
            if(res.ok) {
                // alert(d.message); // Optionnel, peut être gênant
                loadHistory();
            } else {
                alert("Erreur: " + d.message);
            }
        } catch(e) { alert("Erreur Réseau"); }
    }

    // Start
    init();
</script>
</body>
</html>
