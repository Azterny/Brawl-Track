<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âdition Utilisateur - Brawl Track</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { background-color: #121212; color: #eee; font-family: 'Roboto', sans-serif; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        h1, h2 { color: #ffce00; text-transform: uppercase; margin-bottom: 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; text-decoration: none;}
        .btn-back { background: #444; }
        .btn-add { background: #28a745; }
        .btn-edit { background: #17a2b8; padding: 4px 8px; font-size: 0.9em; margin-right: 5px; }
        .btn-del { background: #dc3545; padding: 4px 8px; font-size: 0.9em; }

        /* CHART */
        .chart-box { background: #1e1e1e; padding: 15px; border-radius: 8px; margin-bottom: 30px; height: 300px; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; background: #1e1e1e; margin-top: 20px; font-size: 0.9em; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #252525; color: #ffce00; }
        tr:hover { background: #2a2a2a; }

        /* MODAL */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #252525; padding: 25px; border-radius: 10px; width: 400px; border: 1px solid #444; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #aaa; }
        input { width: 100%; padding: 8px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

<div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#121212; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:999;">
    <h2>üîí Admin Security</h2>
    <input type="password" id="admin-key-input" placeholder="Mot de passe Admin" style="width:200px; text-align:center;">
    <button class="btn btn-add" onclick="checkAdminKey()" style="margin-top:10px;">Valider</button>
</div>

<div class="container">
    <div class="top-bar">
        <div>
            <h1 id="user-title" style="margin:0;">√âdition Utilisateur</h1>
            <span id="user-tag" style="color:#888;">Chargement...</span>
        </div>
        <div>
            <button class="btn btn-add" onclick="openModal()">‚ûï Ajouter un point</button>
            <a href="admin.html" class="btn btn-back">‚¨Ö Retour</a>
        </div>
    </div>

    <div class="chart-box">
        <canvas id="editChart"></canvas>
    </div>

    <h2>Historique Complet</h2>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Troph√©es</th>
                <th>3vs3</th>
                <th>Solo</th>
                <th>Duo</th>
                <th style="text-align:right;">Actions</th>
            </tr>
        </thead>
        <tbody id="history-table"></tbody>
    </table>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title" style="margin-top:0;">Modifier le point</h3>
        <input type="hidden" id="edit-id">
        
        <div class="form-group">
            <label>Date (AAAA-MM-JJ HH:MM:SS)</label>
            <input type="text" id="edit-date">
        </div>
        <div class="form-group">
            <label>Troph√©es üèÜ</label>
            <input type="number" id="edit-trophies">
        </div>
        <div class="form-group">
            <label>Victoires 3vs3 ‚öîÔ∏è</label>
            <input type="number" id="edit-3v3">
        </div>
        <div class="form-group">
            <label>Victoires Solo ü•á</label>
            <input type="number" id="edit-solo">
        </div>
        <div class="form-group">
            <label>Victoires Duo ü§ù</label>
            <input type="number" id="edit-duo">
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-back" onclick="closeModal()">Annuler</button>
            <button class="btn btn-add" onclick="saveData()">Sauvegarder</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://api.brawl-track.com";
    const urlParams = new URLSearchParams(window.location.search);
    const USER_ID = urlParams.get('id');
    let ADMIN_KEY = localStorage.getItem('admin_key_temp') || ""; // Petite persistance temporaire pour confort
    let currentHistory = [];
    let myChart = null;

    // --- SECURITE SIMPLE ---
    function checkAdminKey() {
        const k = document.getElementById('admin-key-input').value;
        if(k) {
            ADMIN_KEY = k;
            localStorage.setItem('admin_key_temp', k); // Sauvegarde pour la session
            loadFullData();
        }
    }

    if(ADMIN_KEY) {
        document.getElementById('login-overlay').style.display = 'none';
        loadFullData();
    }

    // --- CHARGEMENT ---
    async function loadFullData() {
        try {
            const res = await fetch(`${API_URL}/api/admin/player/${USER_ID}/full-history`, {
                headers: { 'X-Admin-Pass': ADMIN_KEY }
            });
            
            if(res.status === 403) {
                document.getElementById('login-overlay').style.display = 'flex';
                alert("Mot de passe expir√© ou incorrect");
                return;
            }

            const data = await res.json();
            document.getElementById('login-overlay').style.display = 'none';
            
            // Header Info
            document.getElementById('user-title').innerText = data.user.username;
            document.getElementById('user-tag').innerText = data.user.brawl_tag;

            currentHistory = data.history;
            renderTable();
            renderChart();

        } catch(e) { console.error(e); alert("Erreur chargement"); }
    }

    // --- RENDU ---
    function renderTable() {
        const tbody = document.getElementById('history-table');
        tbody.innerHTML = '';
        
        currentHistory.forEach(h => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${h.recorded_at}</td>
                <td style="color:#ffce00; font-weight:bold;">${h.trophies}</td>
                <td>${h.victories_3v3}</td>
                <td>${h.victories_solo}</td>
                <td>${h.victories_duo}</td>
                <td style="text-align:right;">
                    <button class="btn btn-edit" onclick='openModal(${JSON.stringify(h)})'>‚úé</button>
                    <button class="btn btn-del" onclick="deletePoint(${h.id})">‚úñ</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderChart() {
        const ctx = document.getElementById('editChart').getContext('2d');
        // Trie par date croissante pour le graph
        const chartData = [...currentHistory].sort((a,b) => new Date(a.recorded_at) - new Date(b.recorded_at));
        
        const dataset = chartData.map(h => ({ x: h.recorded_at, y: h.trophies }));

        if(myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: { 
                datasets: [{ 
                    label: 'Troph√©es', data: dataset, 
                    borderColor: '#ffce00', backgroundColor: 'rgba(255, 206, 0, 0.1)', 
                    borderWidth: 2, tension: 0.1, fill: true, pointRadius: 4, pointHoverRadius: 6
                }] 
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    x: { type: 'time', time: { unit: 'day' }, grid: {color:'#333'} }, 
                    y: { grid: {color:'#333'} } 
                }
            }
        });
    }

    // --- ACTIONS ---
    function openModal(data = null) {
        const modal = document.getElementById('edit-modal');
        modal.classList.add('active');
        
        if (data) {
            // MODE EDITION
            document.getElementById('modal-title').innerText = "Modifier l'archive";
            document.getElementById('edit-id').value = data.id;
            document.getElementById('edit-date').value = data.recorded_at;
            document.getElementById('edit-trophies').value = data.trophies;
            document.getElementById('edit-3v3').value = data.victories_3v3;
            document.getElementById('edit-solo').value = data.victories_solo;
            document.getElementById('edit-duo').value = data.victories_duo;
        } else {
            // MODE CREATION
            document.getElementById('modal-title').innerText = "Ajouter un point";
            document.getElementById('edit-id').value = "";
            
            // Date actuelle par d√©faut
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 19).replace('T', ' ');
            document.getElementById('edit-date').value = dateStr;
            
            // Si possible, on pr√©-remplit avec les derni√®res stats connues
            if (currentHistory.length > 0) {
                const last = currentHistory[0]; // Comme c'est tri√© DESC
                document.getElementById('edit-trophies').value = last.trophies;
                document.getElementById('edit-3v3').value = last.victories_3v3;
                document.getElementById('edit-solo').value = last.victories_solo;
                document.getElementById('edit-duo').value = last.victories_duo;
            } else {
                document.getElementById('edit-trophies').value = 0;
            }
        }
    }

    function closeModal() {
        document.getElementById('edit-modal').classList.remove('active');
    }

    async function saveData() {
        const id = document.getElementById('edit-id').value;
        const payload = {
            user_id: USER_ID,
            recorded_at: document.getElementById('edit-date').value,
            trophies: document.getElementById('edit-trophies').value,
            victories_3v3: document.getElementById('edit-3v3').value,
            victories_solo: document.getElementById('edit-solo').value,
            victories_duo: document.getElementById('edit-duo').value
        };

        const url = id ? `${API_URL}/api/admin/history/${id}` : `${API_URL}/api/admin/history/add`;
        const method = id ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'X-Admin-Pass': ADMIN_KEY },
                body: JSON.stringify(payload)
            });
            
            if(res.ok) {
                closeModal();
                loadFullData(); // Rafraichir
            } else {
                alert("Erreur sauvegarde");
            }
        } catch(e) { alert("Erreur r√©seau"); }
    }

    async function deletePoint(id) {
        if(!confirm("Supprimer ce point d'historique ?")) return;
        try {
            await fetch(`${API_URL}/api/admin/history/${id}`, {
                method: 'DELETE',
                headers: { 'X-Admin-Pass': ADMIN_KEY }
            });
            loadFullData();
        } catch(e) { alert("Erreur suppression"); }
    }

</script>
</body>
</html>
